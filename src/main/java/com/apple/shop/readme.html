package com.apple.shop;

<!--
로그인 유무에 따른 페이지를 접속 하였을 때
컨트롤러에서 통제할 시 그냥 페이지가 튕겨나오는게 유저가 알수 없고 매정하다고 생각해서
타임리프에서 auth조건을 걸어 보여주는걸 온오프 했었다 (URL로 직접 접근하면 노출 위험이 있다.
1) 민감 정보 노출 위험
서버에서 페이지 전체 데이터를 미리 내려주고,
화면에서 div로 가려버리는 구조라면
비로그인 상태에서도 HTML 소스에는 모든 데이터가 포함될 수 있음.
예시: 마이페이지에서 주문내역, 개인정보 등 민감한 정보가
실제로는 HTML에 담겨 있는데,
div로만 숨겨져 있는 경우
사용자가 개발자도구(F12)로 소스코드를 보면
숨겨진 div 안의 정보까지 다 볼 수 있음.
2) API/서버 접근 제어가 안 됨
화면에서만 분기할 뿐,
서버는 비로그인 사용자도 모든 데이터 요청을 허용하게 됨.
예시:
 mypage에 로그인 안 해도 접근 가능
단지 화면에 "로그인하세요"만 보이지만
네트워크 탭이나 JS로 데이터 요청을 보내면
실제 데이터(주문내역, 개인정보 등)가 노출될 수 있음
3) 보안 취약점(불법 접근)
URL만 알면
비로그인 상태에서도 중요한 페이지에 접근할 수 있음.
만약 JS나 브라우저 확장프로그램 등으로
div를 강제로 보이게 하면
원래 숨겨야 할 정보가 노출될 수 있음.)
       하지만 그냥 컨트롤러에서 ?needLogin 쿼리 파라미터를 써서
       리다이렉트 로그인 페이지로 돌아갈 때 따로 멘트를 적는 방식을 사용하게 됐다
성공을 if에 두고 리다이렉트를 빼는 방식이었는데
예외를 if에 두는 방식이 더 많이 쓰인다고해서 반대로 뒤집음
import org.springframework.security.core.authority.SimpleGrantedAuthority;
if (auth != null) {
       System.out.println(auth.getAuthorities().contains(new SimpleGrantedAuthority("일반유저")));
String username = auth.getName();
Member member = memberRepository.findByUsername(username)
       .orElseThrow(() -> new RuntimeException("회원 정보 없음"));
MemberDTO dto = new MemberDTO(
       member.getUsername(),
       member.getEmail(),
       member.getCreatedAt()
);
           model.addAttribute("member", dto);
           return "mypage";
                   }
                   return "redirect:/login?needLogin";
                   }
                   //에서
                   @GetMapping("/mypage")
                   public String myPage(Authentication auth, Model model) {
                       if (auth == null) {
                           return "redirect:/login?needLogin";
                       }
                       String username = auth.getName();
                       Member member = memberRepository.findByUsername(username)
                               .orElseThrow(() -> new RuntimeException("회원 정보 없음"));
                       MemberDTO dto = new MemberDTO(
                               member.getUsername(),
                               member.getEmail(),
                               member.getCreatedAt()
                       );
                       model.addAttribute("member", dto);
                       return "mypage";
                   }

Page와 Slice에 대한 고민
슬라이드스는 끝페이지 조회가 안되어서 교육용으론 페이지 사용하기로

리스트 하단에 페이지 버튼 만들기
페이지를 5개씩 보이게 하고
양쪽 화살표는 5개단위 그룹 이동되게 하기
컨트롤러에서 첫페이지, 끝페이지, 현재 페이지, 현재 페이지가 5의 배수 단위 어디 그룹인지 계산해서 넘기고
타임리프에서 짜넣기

그리고 다시 지저분해진 컨트롤러의 api를 서비스로 보내기 (DTO사용)
모델어트리뷰트를 컨트롤러에 남기는거랑 한줄 통으로 보내는거랑 고민을 함
현업에서의 가독성 이슈 등으로 컨트롤러에 남기고 html 타임리프에서 직관적이게 따서 쓰는 선택

회원가입 버튼이 없고 있는 아이디라고 오류 멤버.java에 @컬럼 유니크를 유저네임에 추가하여 고침

갑자기 리스트에서 삭제버튼 눌러도 안 사라지네?
페이지 추가기능떄문에 오류난줄 알았지만 csrf추가때문이었도 한참 허우적거리다가 발견함
예외에 /delete도 넣어서 해결

고치는 과정에서 리스트.html의 타임리프 문법도 더 정밀하게 고침 이전건 아무튼 우연히 굴러만 가는 코드였었음 (검사-네트워크 확인해보니)
th:inline="javascript"를 추가해서 자바스크립트 문법을 더 단단하게 하고,
|| 파이프 리터럴 문법을 fetch부터 끝에 넣어서 내부의 타임리프 문법을 더 명확하게 하고
'를 활용해서 내부의 문자열들이 혼합되지 않게 연결

페이지네이션을 만들어서 정상 작동 확인 후
컨트롤러에서 DTO와 서비스로 나누자 생기는 오류
밤샘 디버깅을 통해 알아냈지만
컨트롤러에선 안 나던게 서비스와 DTO로 나눌때 나던 이유는
DTO에서 변수와 생성자 순서 적어둔게
서비스에서 마지막 return으로 오브젝트 만들 때 생성자 순서가 어긋났기 때문이었다
진짜 이 하나 때문에 서비스, 컨트롤러, html타임리프에 sout와 표기를 찍어가며 한참을 헤매었다

이미지 업로드 과정
AWS 버킷 생성과 권한 조절, 더 안전하게 사용자 IAM을 만들어 권한 설정 후 사용
업로드하면 서버주소는 생기지만 미리보기 업로드가 안되어 JS수정들

삼항연산자 실수로 리스트 실패


댓글 등록기능 제작
포스트에 무조건 csrf를 넣어야된단걸 한번 까먹음
등록하면 자꾸 400에러나서 페이로드도 sout도 다 뜨는데 이거 찾겠다고 온갖 변수명 확인부터 시큐리티에 csrf에 다 건들다가
결국 컨트롤러에서 리포지터리에 final 하나 안 붙인거였음

댓글 표시기능 폼 css 작성과
리포지터리에서 불러와서 해당 상세페이지의 id번호 찾아서 댓글들 each로 박히게 만들기
자기가 작성한 댓글에만 삭제버튼 활성화되게 작성
누르면 코멘트 아이디를 쏴줘서 삭제
삭제 후 리다이렉트로 다시 그 상세페이지를 가게하려고 parentId도 같이 쏴주게 함
리다이렉트를 쓰려면 타입을 String로 기존엔 ResponseEntity<String> 였음

리스트의 css조절 (숫자 포매팅 등)

search api를 만드는데 api는 작동하지만 list 리턴시 500에러가 남
페이지네이션 타임리프에서 원하는 모델 어트리뷰트를 보내어 해결
검색결과가 나중엔 페이지를 넘어가는 숫자일수도 있으니까

왜 자꾸 검색 하면 500에러가 뜨는지 디버깅 한 결과
검색 api에서 리턴으로 리스트를 갈 때
페이지네이션용 타임리프에 모델 어트리뷰를 안해줬어서
만들어둔 서비스 코드를 재활용해서 모델 어트리뷰트를 하여 해

검색해서 나온 페이지에서 2페이지를 가면 전체 리스트의 2페이지로 가는 현상
타임리프에서 페이지네이션 each에 조건문을 추가

회원가입 성공하고 로그인으로 리다이렉트시 회원가입 완료! 이런 문구가 뜨면 좋을거같아

서버 옮기기 노가다

ngram이 마리아DB로 시작했더니 안됨

주문기능 만들기
디테일에서 주문버튼 눌렀을때 히든으로 id값도 보내기와
컨트롤러 api 내에서 멤버서비스와 아이템서비스 동시에 사용

Optional<..>쓰면 한번 get() 거쳐야되는 원리


아마존 EC2 서버를 며칠 안쓸거라 중지했다가 다시 켰는데
디비버나 인텔리제이 서버 연결이 안되어서 고생했다
새로 할당되는 아이피주소로만 변경하면 될 줄 알았더니
헤매다 알았지만 EC2 인스턴스의 SSH로 가서 마리아 DB를 다시 켜줬어야했다
그런데 SSH연결이 안되어서 한참 헤맸다
들어가기 위해선 인바운드 설정에서 SSH의 22번 포트를 내IP에서 0.0.0.0으로 변경했어야됐다
그렇게 바꿔서 SSH에서 마리아 DB를 재 실행하고 (sudo systemctl start mariadb)
다시 22번 포트를 내 IP로만 접속되게 바꾸는 과정을 한참 헤맨뒤에아 깨달았다

ManytoOne을 DTO 만들어서 주문정보 콘솔 출력 Lazy 주입

관리자와 일반유저를 나누고
관리자만 주문 정보 조회가 보이는 메뉴와 페이지를 작성
주문 서비스에는 불상사를 막기 위해 @Transaction 어노테이션 적용

배포 전 검토들
맴버 DTO에서 검증 어노테이션들은 생략
(나는 맴버DTO를 회원가입 api가 아니라 회원정보 조회에서 사용하기 때문)

AWS S3 이미지 업로드시 확장자와 최대용량 제한 걸기
업로드 파일명 중복 덮어쓰기 방지용 UUID 추가
업로드 조건 안 맞아 오류메세지 띄워주기와 메세지 띄울때 다른 입력값 초기화 안 되게 하기

검색페이지 결과 페이지네이션 최소 1페이지부터 시작하기 (0페이지 안 뜨게)

관리자와 작성자만 리스트에서 수정 아이콘 뜨게, 주소 입력등으로 백엔드에서도 접근 금지 추가
삭제도 마찬가지로 적용

등록 된 댓글도 작성자와 관리자만 삭제 가능하게 변경

배포 테스트 성공 후
접속 했을 때 나쁜짓을 하려는 사람이 제일 먼저 해야할 회원가입의 절차에 보안 작업으로 구글reCHPTCHA v3 추가
회원가입시 같은 IP로 일정시간 내 여러번 가입 제한과 쿠키/세션별 제한으로 ip우회 다중 방어

깃허브에 푸쉬하려는데 자꾸 오류나는데 터미널에 깃허브 비밀번호를 입력하는게 아니라 토큰 발급받아서 입력하는거였다
발급 받아도 왜 안 되나 했더니 세분화된 토큰이어서 안됐다
클래식버전으로 repo체크하고 발급받으니 됐다

바보같이 깃허브에 application.properties를 이그노어 안 걸고 올려버렸었다
알고 강제 푸시등을 이용하여 제거했다

모바일 접속시 상단 navbar가 반응형 디자인이 형편없어서 개선했다

admin 권한을 탈취하려는 sql인젝션,xss공격 등을 방어하기 위해 스프링 시큐리티, html이스케이프(th:text등) csrf등의 방어 대책을 사용

-->

